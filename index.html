<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CheckMe Attendance App</title>
  
  <!-- 1. ផ្ទុក Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. ផ្ទុក React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  
  <!-- 3. ផ្ទុក Babel (សម្រាប់បកប្រែ JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- 4. ផ្ទុក Firebase (v8 compat) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script> 

  <!-- 5. ផ្ទុក Font ខ្មែរ (Kantumruy Pro) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Kantumruy Pro', sans-serif;
      overscroll-behavior-y: contain;
    }
    @keyframes fadeInCard {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in-card {
      opacity: 0;
      animation: fadeInCard 0.4s ease-out forwards;
    }
    @keyframes pageFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .page-content-animation {
      animation: pageFadeIn 0.3s ease-in-out;
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(0.8);
    }
    .dark-theme input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(0.8);
    }
    .glass-theme input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
    }
    #mobile-only-message {
        display: none;
    }
    @media (min-width: 768px) {
        #root { display: none !important; }
        #mobile-only-message {
            display: flex !important;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            background-color: #f3f4f6;
            color: #1f2937;
            text-align: center;
            padding: 2rem;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
        }
    }
  </style>
</head>
<body class="bg-gray-100">
  
  <div id="mobile-only-message">
      <div class="mb-6 bg-white p-4 rounded-full shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500">
              <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
              <line x1="12" y1="18" x2="12.01" y2="18"></line>
          </svg>
      </div>
      <h1 class="text-2xl font-bold mb-3 text-gray-800">សូមអធ្យាស្រ័យ</h1>
      <p class="text-lg text-gray-600 max-w-md">កម្មវិធីនេះត្រូវបានរចនាឡើងសម្រាប់ប្រើប្រាស់នៅលើ <b>ទូរស័ព្ទដៃ</b> ប៉ុណ្ណោះ។</p>
  </div>

  <div id="root"></div>

  <!-- KHMER REACT APP SCRIPT (COMBINED) -->
  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    // --- 1. Icons ---
    const HomeIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    );
    const UserIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
    );
    const SettingsIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 .54 1.81v.65a2 2 0 0 1-.54 1.81l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-.54-1.81v-.65a2 2 0 0 1 .54 1.81l.15.1a2 2 0 0 0 .73 2.73l.22.38a2 2 0 0 0 2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
    );
    const ClockIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
    );
    const BuildingIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="4" width="16" height="18" rx="2" ry="2"></rect><line x1="8" y1="9" x2="16" y2="9"></line><line x1="8" y1="13" x2="16" y2="13"></line><line x1="8" y1="17" x2="12" y2="17"></line></svg>
    );
    const IdIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="16" rx="2" ry="2"></rect><line x1="9" y1="10" x2="15" y2="10"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
    );
    const BookmarkIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
    );
    const ChevronLeftIcon = ({ className, ...props }) => (
      <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    );
    const ChevronRightIcon = ({ className, ...props }) => (
      <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
    );
    const ChartBarIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 20V10M12 20V4M6 20V14"></path></svg>
    );
    const ClipboardListIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
    );
    const TelegramIcon = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
    );

    // --- 2. Themes ---
    const themes = {
      glass: ['bg-gradient-to-br from-purple-600 via-blue-500 to-cyan-400 glass-theme', 'text-white', 'កញ្ចក់ (ដើម)'],
      light: ['bg-gray-100', 'text-gray-800', 'ភ្លឺ (Light)'],
      dark: ['bg-gray-900 dark-theme', 'text-gray-100', 'ងងឹត (Dark)'],
      slate: ['bg-slate-800 dark-theme', 'text-slate-100', 'ងងឹត (Slate)'],
      sky: ['bg-sky-600 glass-theme', 'text-white', 'មេឃ (Sky)'],
      solarizedLight: ['bg-yellow-50', 'text-yellow-900', 'Solarized (ភ្លឺ)'],
      solarizedDark: ['bg-neutral-900 dark-theme', 'text-neutral-100', 'Solarized (ងងឹត)'],
      strawberry: ['bg-pink-100', 'text-pink-800', 'Strawberry'],
      emerald: ['bg-emerald-700 glass-theme', 'text-white', 'ត្បូង (Emerald)'],
      royal: ['bg-indigo-800 glass-theme', 'text-indigo-100', 'រាជ (Royal)'],
      hotpink: ['bg-pink-500 glass-theme', 'text-white', 'ផ្កាឈូក (ខ្លាំង)'],
      white: ['bg-white', 'text-black', 'ស (White)'],
    };

    // --- 3. Functions ---
    const getLocalDate = (date = new Date()) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };
    const formatEnglishDate = (dateString) => {
        if (!dateString) return "";
        try {
            const date = new Date(dateString + 'T00:00:00');
            const day = String(date.getDate()).padStart(2, '0');
            const month = date.toLocaleString('en-US', { month: 'short' });
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        } catch (e) {
            console.error("Error formatting English date:", e);
            return dateString;
        }
    };
    const getLocalTime = () => {
        return new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    };
    const formatKhmerDate = (dateString) => {
      if (!dateString) return "";
      try {
        const date = new Date(dateString + 'T00:00:00');
        const day = date.getDate();
        const monthIndex = date.getMonth();
        const year = date.getFullYear();
        const khmerMonths = ['មករា', 'កុម្ភៈ', 'មីនា', 'មេសា', 'ឧសភា', 'មិថុនា', 'កក្កដា', 'សីហា', 'កញ្ញា', 'តុលា', 'វិច្ឆកា', 'ធ្នូ'];
        return `ទី ${toKhmerNumber(day)} ${khmerMonths[monthIndex]} ${toKhmerNumber(year)}`;
      } catch (e) { return dateString; }
    };
    const toKhmerNumber = (num) => {
      if (num === null || num === undefined) return '';
      const str = String(num);
      const khmerDigits = ['០', '១', '២', '៣', '៤', '៥', '៦', '៧', '៨', '៩'];
      return str.replace(/[0-9]/g, (digit) => khmerDigits[parseInt(digit)]);
    };
    const checkEntryType = (entry) => {
      if (!entry || entry.trim() === '') return 'EMPTY';
      if (/^\d{2}:\d{2}\s(AM|PM)$/i.test(entry)) { return 'TIME'; }
      return 'LEAVE';
    };
    const getTimeValue = (timeStr) => {
        if (!timeStr || !/^\d{2}:\d{2}\s(AM|PM)$/i.test(timeStr)) return -1;
        const [time, modifier] = timeStr.split(' ');
        let [hours, minutes] = time.split(':');
        hours = parseInt(hours, 10);
        minutes = parseInt(minutes, 10);
        if (hours === 12) hours = 0;
        if (modifier === 'PM') hours += 12;
        return hours * 60 + minutes;
    };

    // --- 4. Components ---
    const EditModal = ({ record, onSave, onClose, theme }) => {
      const [checkIn, setCheckIn] = useState(record.checkIn || '');
      const [checkOut, setCheckOut] = useState(record.checkOut || '');
      const [isSaving, setIsSaving] = useState(false);
      const isGlass = theme.bgClass.includes('gradient');
      const modalBg = isGlass ? 'bg-white/30 backdrop-blur-xl' : 'bg-white';
      const textTitle = isGlass ? 'text-white' : 'text-gray-900';
      const textLabel = isGlass ? 'text-gray-100' : 'text-gray-700';
      const textInput = isGlass ? 'text-white placeholder-gray-300' : 'text-gray-900 placeholder-gray-400';
      const inputBg = isGlass ? 'bg-white/20 border-white/30' : 'bg-white border-gray-300';
      const infoBg = isGlass ? 'bg-black/20' : 'bg-gray-100';

      const handleSave = async () => {
        setIsSaving(true);
        try {
          await onSave({ ...record, checkIn, checkOut }, false);
        } catch (error) { console.error(error); } 
        finally { setIsSaving(false); onClose(); }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 page-content-animation">
          <div className={`rounded-2xl shadow-xl w-full max-w-sm p-5 ${modalBg}`}>
            <h2 className={`text-xl font-bold mb-2 ${textTitle}`}>កែប្រែទិន្នន័យ</h2>
            <div className={`mb-4 p-3 rounded-lg ${infoBg}`}>
              <p className={`font-semibold ${textTitle}`}>{record.employeeName}</p>
              <p className={`text-sm ${textLabel}`}>ID: {toKhmerNumber(record.employeeId)} | {formatKhmerDate(record.dateId)}</p>
            </div>
            <div className="space-y-4">
              <div>
                <label className={`block text-sm font-medium mb-1 ${textLabel}`}>Check In</label>
                <input type="text" value={checkIn} onChange={(e) => setCheckIn(e.target.value)} className={`w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 ${inputBg} ${textInput}`} placeholder="ឧទាហរណ៍: 08:00 AM" />
              </div>
              <div>
                <label className={`block text-sm font-medium mb-1 ${textLabel}`}>Check Out</label>
                <input type="text" value={checkOut} onChange={(e) => setCheckOut(e.target.value)} className={`w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 ${inputBg} ${textInput}`} placeholder="ឧទាហរណ៍: 05:30 PM" />
              </div>
            </div>
            <div className="mt-6 flex justify-end space-x-3">
              <button onClick={onClose} disabled={isSaving} className={`px-4 py-2 rounded-md hover:opacity-80 disabled:opacity-50 ${isGlass ? 'bg-white/20 text-white' : 'bg-gray-200 text-gray-800'}`}>បោះបង់</button>
              <button onClick={handleSave} disabled={isSaving} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50">{isSaving ? 'កំពុងរក្សាទុក...' : 'រក្សាទុក'}</button>
            </div>
          </div>
        </div>
      );
    };

    const ManualEntryModal = ({ employee, existingRecord, dateId, shift, onSave, onClose, theme }) => {
      const [checkIn, setCheckIn] = useState(existingRecord.checkIn || '');
      const [checkOut, setCheckOut] = useState(existingRecord.checkOut || '');
      const [isSaving, setIsSaving] = useState(false);
      const isGlass = theme.bgClass.includes('gradient');
      const modalBg = isGlass ? 'bg-white/30 backdrop-blur-xl' : 'bg-white';
      const textTitle = isGlass ? 'text-white' : 'text-gray-900';
      const textLabel = isGlass ? 'text-gray-100' : 'text-gray-700';
      const textInput = isGlass ? 'text-white placeholder-gray-300' : 'text-gray-900 placeholder-gray-400';
      const inputBg = isGlass ? 'bg-white/20 border-white/30' : 'bg-white border-gray-300';
      const infoBg = isGlass ? 'bg-black/20' : 'bg-gray-100';

      const handleSave = async () => {
        setIsSaving(true);
        try {
          const formattedDate = formatEnglishDate(dateId);
          await onSave({
            employeeId: String(employee['ID']), dateId, checkIn, checkOut,
            employeeName: employee['NAME'], department: employee['DEPT'], grade: employee['GRADE'],
            gender: employee['GENDER'], group: employee['GROUP'], shift, date: dateId, formattedDate
          }, true);
        } catch (error) { console.error(error); }
        finally { setIsSaving(false); onClose(); }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 page-content-animation">
          <div className={`rounded-2xl shadow-xl w-full max-w-sm p-5 ${modalBg}`}>
            <h2 className={`text-xl font-bold mb-2 ${textTitle}`}>ចុះវត្តមានដោយដៃ (Admin)</h2>
            <div className={`mb-4 p-3 rounded-lg ${infoBg}`}>
              <p className={`font-semibold ${textTitle}`}>{employee['NAME']}</p>
              <p className={`text-sm ${textLabel}`}>ID: {toKhmerNumber(employee['ID'])} | {formatKhmerDate(dateId)}</p>
              <p className={`text-sm ${textLabel} font-medium`}>វេន: {shift}</p>
            </div>
            <div className="space-y-4">
              <div>
                <label className={`block text-sm font-medium mb-1 ${textLabel}`}>Check In (ម៉ោងចូល ឬ មូលហេតុ)</label>
                <input type="text" value={checkIn} onChange={(e) => setCheckIn(e.target.value)} className={`w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 ${inputBg} ${textInput}`} placeholder="ឧទា: 08:00 AM ឬ សុំច្បាប់" />
              </div>
              <div>
                <label className={`block text-sm font-medium mb-1 ${textLabel}`}>Check Out (ម៉ោងចេញ ឬ មូលហេតុ)</label>
                <input type="text" value={checkOut} onChange={(e) => setCheckOut(e.target.value)} className={`w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 ${inputBg} ${textInput}`} placeholder="ឧទា: 08:00 AM ឬ សុំច្បាប់" />
              </div>
            </div>
            <div className="mt-6 flex justify-end space-x-3">
              <button onClick={onClose} disabled={isSaving} className={`px-4 py-2 rounded-md hover:opacity-80 disabled:opacity-50 ${isGlass ? 'bg-white/20 text-white' : 'bg-gray-200 text-gray-800'}`}>បោះបង់</button>
              <button onClick={handleSave} disabled={isSaving} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50">{isSaving ? 'កំពុងរក្សាទុក...' : 'រក្សាទុក'}</button>
            </div>
          </div>
        </div>
      );
    };

    const ToggleSwitch = ({ label, enabled, onChange, theme }) => {
      const isGlass = theme.bgClass.includes('gradient');
      const bgCard = isGlass ? 'bg-white/10 backdrop-blur-md' : 'bg-white shadow-sm border border-gray-100';
      const textClass = isGlass ? 'text-gray-100' : 'text-gray-700';
      return (
        <div className={`flex items-center justify-between p-4 rounded-xl ${bgCard}`}>
          <span className={`font-medium ${textClass}`}>{label}</span>
          <button onClick={() => onChange(!enabled)} className={`relative inline-flex items-center h-6 rounded-full w-11 transition-colors ${enabled ? 'bg-blue-500' : (isGlass ? 'bg-black/20' : 'bg-gray-300')}`}>
            <span className={`inline-block w-4 h-4 transform bg-white rounded-full transition-transform ${enabled ? 'translate-x-6' : 'translate-x-1'}`} />
          </button>
        </div>
      );
    };

    const PaginationControls = ({ currentPage, totalPages, onNext, onPrev, theme }) => {
      if (totalPages <= 1) return null;
      const isGlass = theme.bgClass.includes('gradient');
      const btnBg = isGlass ? 'bg-white/20 backdrop-blur-md text-white' : 'bg-white shadow-md text-blue-600';
      const textClass = isGlass ? 'text-gray-100' : 'text-gray-700';
      return (
        <div className="flex items-center justify-between mt-6 px-4">
          <button onClick={onPrev} disabled={currentPage === 1} className={`flex items-center justify-center p-2 rounded-full transition-all disabled:opacity-30 ${btnBg} hover:opacity-80`}><ChevronLeftIcon className="w-6 h-6" /></button>
          <span className={`font-medium text-sm ${textClass}`}>ទំព័រ {toKhmerNumber(currentPage)} / {toKhmerNumber(totalPages)}</span>
          <button onClick={onNext} disabled={currentPage === totalPages} className={`flex items-center justify-center p-2 rounded-full transition-all disabled:opacity-30 ${btnBg} hover:opacity-80`}><ChevronRightIcon className="w-6 h-6" /></button>
        </div>
      );
    };

    // --- 5. Page Components ---
    const AttendanceList = ({ records, loading, error, entryMode, onRecordClick, currentPage, setCurrentPage, theme, schedules = {}, filterUserShift }) => {
      const [searchQuery, setSearchQuery] = useState('');
      
      const processedRecords = useMemo(() => {
        let data = [...records];
        if (searchQuery.trim() !== '') {
            const lowerQuery = searchQuery.toLowerCase();
            data = data.filter(record => 
                (record.employeeName && record.employeeName.toLowerCase().includes(lowerQuery)) ||
                (record.employeeId && String(record.employeeId).toLowerCase().includes(lowerQuery))
            );
        }
        
        // --- STRICT FILTERING FIX HERE ---
        const normalize = (str) => {
           if (!str) return '';
           return str.replace(/\s+/g, '').replace(/[០-៩]/g, d => "0123456789"['០១២៣៤៥៦៧៨៩'.indexOf(d)]).toLowerCase();
        };
        const targetDepts = ['IT Support', 'DRB'].map(normalize);
        
        data = data.filter(record => {
            const rDept = normalize(record.department);
            const rGroup = normalize(record.group);
            return targetDepts.some(target => 
                (rDept && rDept.includes(target)) || 
                (rGroup && rGroup.includes(target))
            );
        });
        // ----------------------------------

        if (filterUserShift !== 'ALL') {
            data = data.filter(record => {
                if (!schedules || !schedules[record.employeeId]) return false;
                const empSchedule = schedules[record.employeeId];
                const date = new Date(record.dateId + 'T00:00:00');
                const dayIndex = date.getDay();
                const shiftKeys = ['SHIFT_SUN', 'SHIFT_MON', 'SHIFT_TUE', 'SHIFT_WED', 'SHIFT_THU', 'SHIFT_FRI', 'SHIFT_SAT'];
                const shift = empSchedule[shiftKeys[dayIndex]];
                if (!shift) return false;
                return normalize(shift).includes(normalize(filterUserShift)) || normalize(filterUserShift).includes(normalize(shift));
            });
        }

        data.sort((a, b) => {
            const hasCheckInA = checkEntryType(a.checkIn) === 'TIME';
            const hasCheckInB = checkEntryType(b.checkIn) === 'TIME';
            if (hasCheckInA && !hasCheckInB) return -1; 
            if (!hasCheckInA && hasCheckInB) return 1;  
            if (a.dateId !== b.dateId) return b.dateId.localeCompare(a.dateId); 
            return getTimeValue(b.checkIn) - getTimeValue(a.checkIn); 
        });
        return data;
      }, [records, searchQuery, filterUserShift, schedules]);

      const ITEMS_PER_PAGE = 12;
      const totalPages = Math.ceil(processedRecords.length / ITEMS_PER_PAGE);
      const currentItems = processedRecords.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);
      
      useEffect(() => { setCurrentPage(1); }, [searchQuery]);
      const nextPage = () => setCurrentPage(prev => Math.min(prev + 1, totalPages));
      const prevPage = () => setCurrentPage(prev => Math.max(prev - 1, 1));
      
      const isGlass = theme.bgClass.includes('gradient');
      const bgCard = isGlass ? 'bg-white/10 backdrop-blur-md' : 'bg-white shadow-lg border border-gray-100';
      const textTitle = isGlass ? 'text-white' : 'text-gray-800';
      const textSubtitle = isGlass ? 'text-gray-200' : 'text-gray-500';
      const bgIconGreen = isGlass ? 'bg-green-500/20' : 'bg-green-100';
      const bgIconRed = isGlass ? 'bg-red-500/20' : 'bg-red-100';
      const bgIconMuted = isGlass ? 'bg-gray-500/20' : 'bg-gray-100';
      const borderCard = isGlass ? 'border-t border-white/10' : 'border-t border-gray-100';
      const ringClass = isGlass ? 'hover:ring-white/50' : 'hover:ring-blue-500';
      const inputBg = isGlass ? 'bg-white/20 border-white/30 text-white placeholder-gray-300' : 'bg-white border-gray-300 text-gray-900 placeholder-gray-400';
      const textGreen = isGlass ? 'text-green-300' : 'text-green-700';
      const textRed = 'text-red-500 font-bold';
      const textRedTime = isGlass ? 'text-red-300' : 'text-red-700';
      const textMuted = isGlass ? 'text-gray-300' : 'text-gray-400';

      if (loading) return <div className="flex justify-center items-center h-full p-6">កំពុងទាញទិន្នន័យ...</div>;
      if (error) return <div className="p-4"><div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative"><strong>Error: </strong>{error}</div></div>;

      return (
        <div className="pb-4 pt-4">
          <div className="px-4 mb-4">
             <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="ស្វែងរក (ឈ្មោះ ឬ ID)..." className={`w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-blue-400 ${inputBg}`} />
          </div>
          {processedRecords.length === 0 ? <div className="flex justify-center items-center h-64 p-6 text-center">មិនមានទិន្នន័យសម្រាប់បង្ហាញទេ។</div> : (
            <div className="space-y-4 px-4">
                {currentItems.map((record, index) => {
                  const employee = schedules[record.employeeId] || {};
                  const photoUrl = employee.PHOTO || record.photo || `https://placehold.co/40x40/E2E8F0/A0AEC0?text=${record.employeeName ? record.employeeName[0] : 'P'}`;
                  let telegramUrl = employee.TELEGRAM;
                  if (telegramUrl && !telegramUrl.startsWith('http') && !telegramUrl.startsWith('tg://')) telegramUrl = `https://t.me/${telegramUrl.replace('@', '')}`;
                  return (
                <div key={record.id} onClick={() => entryMode && onRecordClick(record)} className={`p-4 rounded-xl overflow-hidden transition-all fade-in-card ${bgCard} ${entryMode ? `cursor-pointer hover:shadow-xl hover:ring-2 ${ringClass}` : ''}`} style={{ animationDelay: `${index * 50}ms` }}>
                    <div className="flex items-start space-x-3">
                      <div className="flex-shrink-0">
                        <img src={photoUrl} alt={record.employeeName} className="w-16 h-16 rounded-full object-cover border-2 border-white/20" onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/64/E2E8F0/A0AEC0?text=${record.employeeName ? record.employeeName[0] : 'P'}`; }} />
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex justify-between items-start">
                           <div className="flex items-center space-x-2 overflow-hidden">
                              <h2 className={`text-xl font-bold truncate ${textTitle}`} title={record.employeeName}>{record.employeeName}</h2>
                              {telegramUrl && (<a href={telegramUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:text-blue-600 flex-shrink-0" onClick={(e) => e.stopPropagation()}><TelegramIcon className="w-5 h-5 text-blue-500" /></a>)}
                           </div>
                           <div className={`flex-shrink-0 flex items-center ml-2 ${textSubtitle}`}><IdIcon className="w-4 h-4 mr-1.5" /><span className="text-sm font-mono font-medium">ID: {toKhmerNumber(record.employeeId)}</span></div>
                        </div>
                        {record.shift && (<div className={`flex items-center mt-1 ${isGlass ? 'text-yellow-300' : 'text-yellow-600'}`}><span className="text-xs font-semibold px-2 py-0.5 rounded bg-yellow-500/20 border border-yellow-500/30">{record.shift}</span></div>)}
                        {record.grade && (<div className={`flex items-center mt-1.5 ${textSubtitle}`}><BookmarkIcon className="w-4 h-4 mr-2" /><span className="text-sm font-medium truncate">{record.grade}</span></div>)}
                        <div className={`flex items-center ${record.grade ? 'mt-1' : 'mt-1.5'} ${textSubtitle}`}><BuildingIcon className="w-4 h-4 mr-2" /><span className="text-sm font-medium truncate">{record.department}</span></div>
                        <span className={`text-sm font-medium mt-1 block ${isGlass ? 'text-blue-300' : 'text-blue-600'}`}>{formatKhmerDate(record.dateId)}</span>
                    </div>
                    </div>
                    <div className={`grid grid-cols-2 gap-4 pt-4 mt-4 ${borderCard}`}>
                    <div className="flex items-center space-x-3">
                        <div className={`p-3 rounded-full ${checkEntryType(record.checkIn) === 'TIME' ? bgIconGreen : bgIconRed}`}><ClockIcon className={`w-5 h-5 ${checkEntryType(record.checkIn) === 'TIME' ? textGreen : textRed}`} /></div>
                        <div><span className={`text-xs ${textSubtitle}`}>Check In</span>{checkEntryType(record.checkIn) === 'TIME' ? (<p className={`font-bold text-lg ${textGreen}`}>{toKhmerNumber(record.checkIn)}</p>) : (<p className={`font-bold text-base ${textRed}`}>{checkEntryType(record.checkIn) === 'LEAVE' ? (record.checkIn || 'សុំច្បាប់') : 'អវត្តមាន'}</p>)}</div>
                    </div>
                    <div className="flex items-center space-x-3">
                        <div className={`p-3 rounded-full ${checkEntryType(record.checkOut) === 'TIME' ? bgIconRed : (checkEntryType(record.checkIn) === 'TIME' ? bgIconMuted : bgIconRed)}`}><ClockIcon className={`w-5 h-5 ${checkEntryType(record.checkOut) === 'TIME' ? textRedTime : (checkEntryType(record.checkIn) === 'TIME' ? textMuted : textRed)}`} /></div>
                        <div><span className={`text-xs ${textSubtitle}`}>Check Out</span>{checkEntryType(record.checkOut) === 'TIME' ? (<p className={`font-bold text-lg ${textRedTime}`}>{toKhmerNumber(record.checkOut)}</p>) : (<p className={`font-bold text-base ${checkEntryType(record.checkIn) === 'TIME' ? textMuted : textRed}`}>{checkEntryType(record.checkOut) === 'LEAVE' ? (record.checkOut || 'សុំច្បាប់') : 'អវត្តមាន'}</p>)}</div>
                    </div>
                    </div>
                </div>
                )})}
            </div>
          )}
          <PaginationControls currentPage={currentPage} totalPages={totalPages} onNext={nextPage} onPrev={prevPage} theme={theme} />
        </div>
      );
    };

    const ProfilePage = ({ theme }) => {
      const isGlass = theme.bgClass.includes('gradient');
      const textTitle = isGlass ? 'text-white' : 'text-gray-800';
      const textSubtitle = isGlass ? 'text-gray-300' : 'text-gray-500';
      return (
        <div className="p-6 text-center">
          <UserIcon className={`w-24 h-24 mx-auto ${isGlass ? 'text-white/30' : 'text-gray-300'}`} />
          <h2 className={`text-2xl font-semibold mt-4 ${textTitle}`}>ទំព័រគណនី</h2>
          <p className={`mt-2 ${textSubtitle}`}>មុខងារនេះនឹងត្រូវបន្ថែមក្នុងពេលឆាប់ៗនេះ។</p>
        </div>
      );
    };

    const ReportPage = ({ records, theme }) => {
      const [selectedDate, setSelectedDate] = useState(getLocalDate());
      const stats = useMemo(() => {
        const normalize = (str) => { if (!str) return ''; return str.replace(/\s+/g, '').replace(/[០-៩]/g, d => "0123456789"['០១២៣៤៥៦៧៨៩'.indexOf(d)]).toLowerCase(); };
        const targetDepts = ['IT Support', 'DRB'].map(normalize);
        const deptRecords = records.filter(r => {
            const rDept = normalize(r.department);
            const rGroup = normalize(r.group);
            return targetDepts.some(target => (rDept && rDept.includes(target)) || (rGroup && rGroup.includes(target)));
        });
        const todayRecords = deptRecords.filter(r => r.dateId === selectedDate);
        const leaveRecords = [], attendanceRecords = [];
        todayRecords.forEach(r => (checkEntryType(r.checkIn) === 'LEAVE' || checkEntryType(r.checkOut) === 'LEAVE') ? leaveRecords.push(r) : attendanceRecords.push(r));
        let totalToday = attendanceRecords.length, completeToday = 0, scannedInOnlyToday = 0, incompleteToday = 0;
        const statsByDept = {};
        attendanceRecords.forEach(record => {
          const dept = (record.department || 'N/A').toUpperCase();
          if (!statsByDept[dept]) statsByDept[dept] = { totalAttendance: 0, complete: 0, scannedInOnly: 0, incomplete: 0, onLeave: 0 };
          statsByDept[dept].totalAttendance++;
          const inType = checkEntryType(record.checkIn), outType = checkEntryType(record.checkOut);
          if (inType === 'TIME' && outType === 'TIME') { completeToday++; statsByDept[dept].complete++; }
          else if (inType === 'TIME' && outType !== 'TIME') { scannedInOnlyToday++; statsByDept[dept].scannedInOnly++; }
          else { incompleteToday++; statsByDept[dept].incomplete++; }
        });
        leaveRecords.forEach(record => {
            const dept = (record.department || 'N/A').toUpperCase();
            if (!statsByDept[dept]) statsByDept[dept] = { totalAttendance: 0, complete: 0, scannedInOnly: 0, incomplete: 0, onLeave: 0 };
            statsByDept[dept].onLeave++;
        });
        return { totalToday, completeToday, scannedInOnlyToday, incompleteToday, onLeaveToday: leaveRecords.length, statsByDept };
      }, [records, selectedDate]);

      const isGlass = theme.bgClass.includes('gradient');
      const bgCard = isGlass ? 'bg-white/10 backdrop-blur-md' : 'bg-white shadow-md';
      const bgHeader = isGlass ? 'bg-black/10' : 'bg-gray-5 border-b border-gray-100';
      const textTitle = isGlass ? 'text-white' : 'text-gray-800';
      const textLabel = isGlass ? 'text-gray-100' : 'text-gray-600';
      const textValue = isGlass ? 'text-white' : 'text-gray-900';
      const textHeader = isGlass ? 'text-blue-300' : 'text-blue-600';
      const inputBg = isGlass ? 'bg-white/20 border-white/30 text-white' : 'bg-white border-gray-300 text-gray-900';
      const StatItem = ({ label, value }) => (<div className="flex justify-between items-center p-3"><span className={`text-sm ${textLabel}`}>{label}</span><span className={`font-bold text-lg ${textValue}`}>{toKhmerNumber(value)}</span></div>);

      return (
        <div className="p-4 space-y-6">
          <h2 className={`text-center text-lg font-semibold ${textHeader}`}>ទិន្នន័យប្រចាំ{formatKhmerDate(selectedDate)}</h2>
          <div className="px-0"><label className={`block text-sm font-medium mb-1 ${isGlass ? 'text-gray-100' : 'text-gray-700'}`}>ជ្រើសរើសកាលបរិច្ឆេទ</label><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className={`w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-blue-400 ${inputBg}`} /></div>
          <div className={`rounded-xl overflow-hidden ${bgCard}`}>
            <div className={`p-3 ${bgHeader}`}><h3 className={`font-semibold ${textTitle}`}>សរុបទូទៅ (ប្រចាំថ្ងៃ)</h3></div>
            <div className="divide-y divide-gray-100/10">
              <StatItem label="បុគ្គលិកបានស្កេន (សរុបថ្ងៃនេះ)" value={stats.totalToday} />
              <StatItem label="ចំនួនបុគ្គលិកបានស្កេនពេញលេញ" value={stats.completeToday} />
              <StatItem label="ចំនួនបុគ្គលិកបានស្កេនចូល" value={stats.scannedInOnlyToday} />
              <StatItem label="ចំនួនបុគ្គលិកទិន្នន័យមិនពេញលេញ" value={stats.incompleteToday} />
              <StatItem label="សុំច្បាប់" value={stats.onLeaveToday} />
            </div>
          </div>
          <div>
            <h3 className={`font-semibold mb-2 ${textTitle}`}>សរុបតាមក្រុម (ប្រចាំថ្ងៃ)</h3>
            <div className="space-y-4">{Object.keys(stats.statsByDept).length === 0 ? (<div className={`p-4 rounded-xl text-center ${bgCard} ${textLabel}`}>មិនមានទិន្នន័យសម្រាប់ថ្ងៃ {formatKhmerDate(selectedDate)} ទេ។</div>) : (Object.entries(stats.statsByDept).map(([deptName, deptStats]) => (<div key={deptName} className={`rounded-xl overflow-hidden ${bgCard}`}><div className={`p-3 ${bgHeader}`}><h4 className={`font-semibold ${textTitle}`}>{deptName}</h4></div><div className="divide-y divide-gray-100/10"><StatItem label="សរុបក្នុងក្រុម (វត្តមាន)" value={deptStats.totalAttendance} /><StatItem label="ចំនួនបុគ្គលិកបានស្កេនពេញលេញ" value={deptStats.complete} /><StatItem label="ចំនួនបុគ្គលិកបានស្កេនចូល" value={deptStats.scannedInOnly} /><StatItem label="ចំនួនបុគ្គលិកទិន្នន័យមិនពេញលេញ" value={deptStats.incomplete} /><StatItem label="សុំច្បាប់" value={deptStats.onLeave} /></div></div>)))}</div>
          </div>
        </div>
      );
    };

    const SettingsPage = ({ filterToday, setFilterToday, filterIncomplete, setFilterIncomplete, filterIncompleteNotToday, setFilterIncompleteNotToday, filterScannedInOnly, setFilterScannedInOnly, filterCompleteScan, setFilterCompleteScan, entryMode, setEntryMode, activeThemeKey, onThemeChange, theme, adminShiftFilter, setAdminShiftFilter, VALID_SHIFTS, filterUserShift, setFilterUserShift }) => {
      const isGlass = theme.bgClass.includes('gradient');
      const textTitle = isGlass ? 'text-white' : 'text-gray-800';
      const bgCard = isGlass ? 'bg-white/10 backdrop-blur-md' : 'bg-white shadow-sm';
      const textLabel = isGlass ? 'text-gray-100' : 'text-gray-700';
      const inputBg = isGlass ? 'bg-white/20 border-white/30 text-white' : 'bg-white border-gray-300 text-gray-900';
      const optionBg = isGlass ? 'bg-gray-800 text-white' : 'bg-white text-black';
      
      const handleFilterChange = (setter, value) => {
        setFilterToday(setter === setFilterToday ? value : false);
        setFilterIncomplete(setter === setFilterIncomplete ? value : false);
        setFilterIncompleteNotToday(setter === setFilterIncompleteNotToday ? value : false);
        setFilterScannedInOnly(setter === setFilterScannedInOnly ? value : false);
        setFilterCompleteScan(setter === setFilterCompleteScan ? value : false);
      };
      
      const userShifts = ['Uptime','ពេញម៉ោង','ពេលយប់','មួយព្រឹក','មួយរសៀល'];

      return (
        <div className="p-4 space-y-6">
          <div>
            <h2 className={`text-xl font-semibold px-2 mb-2 ${textTitle}`}>តម្រងបង្ហាញ (ទំព័រដើម)</h2>
            <div className="space-y-3">
              <div className={`p-4 rounded-xl ${bgCard} mb-4`}>
                <label className={`block text-sm font-medium mb-2 ${textLabel}`}>ត្រងតាមវេន (Home Page)</label>
                <select value={filterUserShift} onChange={(e) => setFilterUserShift(e.target.value)} className={`w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-blue-400 ${inputBg}`}><option value="ALL" className={optionBg}>-- គ្រប់វេន --</option>{userShifts.map(shift => (<option key={shift} value={shift} className={optionBg}>{shift}</option>))}</select>
              </div>
              <ToggleSwitch label="បង្ហាញតែថ្ងៃនេះ" enabled={filterToday} onChange={(val) => handleFilterChange(setFilterToday, val)} theme={theme} />
              <ToggleSwitch label="បង្ហាញតែទិន្នន័យមិនពេញលេញ" enabled={filterIncomplete} onChange={(val) => handleFilterChange(setFilterIncomplete, val)} theme={theme} />
              <ToggleSwitch label="បង្ហាញមិនពេញលេញ (ក្រៅពីថ្ងៃនេះ)" enabled={filterIncompleteNotToday} onChange={(val) => handleFilterChange(setFilterIncompleteNotToday, val)} theme={theme} />
              <ToggleSwitch label="បង្ហាញតែអ្នកស្កេនចូល (Scanned In Only)" enabled={filterScannedInOnly} onChange={(val) => handleFilterChange(setFilterScannedInOnly, val)} theme={theme} />
              <ToggleSwitch label="បង្ហាញអ្នកស្កេនពេញលេញ (Complete Scan)" enabled={filterCompleteScan} onChange={(val) => handleFilterChange(setFilterCompleteScan, val)} theme={theme} />
            </div>
          </div>
          <div>
            <h2 className={`text-xl font-semibold px-2 mb-2 pt-4 ${textTitle}`}>តម្រង (ទំព័រ Admin)</h2>
            <div className={`p-4 rounded-xl space-y-4 ${bgCard}`}>
              <div>
                <label className={`block text-sm font-medium mb-1 ${textLabel}`}>ត្រងតាមវេន</label>
                <select value={adminShiftFilter} onChange={(e) => setAdminShiftFilter(e.target.value)} className={`w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-blue-400 ${inputBg}`}><option value="ALL" className={optionBg}>-- គ្រប់វេន --</option>{VALID_SHIFTS.map(shift => (<option key={shift} value={shift} className={optionBg}>{shift}</option>))}</select>
              </div>
            </div>
          </div>
          <div>
            <h2 className={`text-xl font-semibold px-2 mb-2 pt-4 ${textTitle}`}>ការបញ្ចូលទិន្នន័យ</h2>
            <ToggleSwitch label="បើករបៀបកែប្រែ/បញ្ចូល" enabled={entryMode} onChange={setEntryMode} theme={theme} />
            {entryMode && (<p className={`text-sm px-2 mt-2 ${isGlass ? 'text-gray-200' : 'text-gray-600'}`}>នៅពេលបើក, អ្នកអាចចូលទៅទំព័រដើម ហើយចុចលើ Card ណាមួយដើម្បីកែប្រែទិន្នន័យ។</p>)}
          </div>
          <div>
            <h2 className={`text-xl font-semibold px-2 mb-2 pt-4 ${textTitle}`}>រចនាបថ (UI Themes)</h2>
            <div className={`p-4 rounded-xl ${bgCard}`}><div className="grid grid-cols-4 gap-4">{Object.entries(themes).map(([key, themeData]) => (<div key={key} className="flex flex-col items-center" onClick={() => onThemeChange(key)}><button className={`w-12 h-12 rounded-full border-2 transition-all ${activeThemeKey === key ? 'border-blue-500 scale-110 ring-2 ring-blue-500/50' : (isGlass ? 'border-white/20' : 'border-gray-200')} ${themeData[0]}`}></button><span className={`text-xs mt-2 text-center ${textLabel}`}>{themeData[2]}</span></div>))}</div></div>
          </div>
        </div>
      );
    };

    const AttendanceAdminPage = ({ schedules, attendanceRecords, onManualCheckIn, theme, loadingSchedules, adminGroupFilter, adminShiftFilter, VALID_SHIFTS }) => {
      const [selectedDate, setSelectedDate] = useState(getLocalDate());
      const [modalInfo, setModalInfo] = useState({ isOpen: false, employee: null, shift: null, existingRecord: {} });
      const [searchTerm, setSearchTerm] = useState('');
      const isGlass = theme.bgClass.includes('gradient');
      const textTitle = isGlass ? 'text-white' : 'text-gray-800';
      const textHeader = isGlass ? 'text-blue-300' : 'text-blue-600';
      const textLabel = isGlass ? 'text-gray-100' : 'text-gray-700';
      const inputBg = isGlass ? 'bg-white/20 border-white/30 text-white' : 'bg-white border-gray-300 text-gray-900';
      const bgCard = isGlass ? 'bg-white/10 backdrop-blur-md' : 'bg-white shadow-md';
      const bgItem = isGlass ? 'bg-white/10' : 'bg-white';
      const textName = isGlass ? 'text-white' : 'text-gray-800';
      const textDept = isGlass ? 'text-gray-200' : 'text-gray-600';
      const textId = isGlass ? 'text-purple-300' : 'text-purple-700';
      const textShift = isGlass ? 'text-yellow-300' : 'text-yellow-700';

      const { todayRecordsMap, todayDate, shiftKey } = useMemo(() => {
        const date = new Date(selectedDate + 'T00:00:00');
        const todayDateStr = getLocalDate(date);
        const dayIndex = date.getDay(); 
        const shiftKeys = ['SHIFT_SUN', 'SHIFT_MON', 'SHIFT_TUE', 'SHIFT_WED', 'SHIFT_THU', 'SHIFT_FRI', 'SHIFT_SAT'];
        const recordsMap = new Map();
        attendanceRecords.forEach(r => { if (r.dateId === todayDateStr) recordsMap.set(String(r.employeeId), r); });
        return { todayRecordsMap: recordsMap, todayDate: date, shiftKey: shiftKeys[dayIndex] };
      }, [attendanceRecords, selectedDate]);
      
      const getEmployeeShift = (employee) => employee[shiftKey] || 'N/A';
      
      const scheduledStaff = useMemo(() => {
        if (loadingSchedules || Object.keys(schedules).length === 0) return [];
        const normalize = (str) => { if (!str) return ''; return str.replace(/\s+/g, '').replace(/[០-៩]/g, d => "0123456789"['០១២៣៤៥៦៧៨៩'.indexOf(d)]).toLowerCase(); };
        let scheduledToday = Object.values(schedules).filter(emp => {
             // --- STRICT FILTERING FIX HERE ---
             const targetDepts = ['IT Support', 'DRB'].map(normalize);
             const empDept = normalize(emp['DEPT']);
             const empGroup = normalize(emp['GROUP']);
             const isMatch = targetDepts.some(target => (empDept && empDept.includes(target)) || (empGroup && empGroup.includes(target)));
             if (!isMatch) return false;
             // ---------------------------------
          const shift = getEmployeeShift(emp);
          if (!shift || shift.trim() === '') return false;
          if (adminShiftFilter !== 'ALL' && shift.trim().toUpperCase() !== adminShiftFilter.toUpperCase()) return false;
          return VALID_SHIFTS.some(validShift => {
            const upperValidShift = validShift.toUpperCase();
            return shift.trim().toUpperCase().includes(upperValidShift) || upperValidShift.includes(shift.trim().toUpperCase()); 
          });
        });
        
        if (searchTerm.trim() !== '') {
          const lowerSearchTerm = searchTerm.toLowerCase();
          scheduledToday = scheduledToday.filter(emp => { 
            const name = emp['NAME'] ? emp['NAME'].toLowerCase() : '';
            const id = emp['ID'] ? String(emp['ID']).toLowerCase() : '';
            return name.includes(lowerSearchTerm) || id.includes(lowerSearchTerm);
          });
        }
        scheduledToday = scheduledToday.filter(emp => {
            const empId = String(emp['ID']);
            const record = todayRecordsMap.get(empId);
            return !record || checkEntryType(record.checkIn) === 'EMPTY';
        });
        scheduledToday.sort((a, b) => (a['NAME'] || '').localeCompare(b['NAME'] || '')); 
        return scheduledToday; 
      }, [schedules, shiftKey, loadingSchedules, adminGroupFilter, adminShiftFilter, searchTerm, VALID_SHIFTS, todayRecordsMap]); 

      const formattedTitle = formatKhmerDate(selectedDate);
      const handleOpenModal = (employee) => {
        const empId = String(employee['ID']);
        const existingRecord = todayRecordsMap.get(empId) || {};
        const shift = getEmployeeShift(employee);
        setModalInfo({ isOpen: true, employee, shift, existingRecord });
      };
      const handleCloseModal = () => { setModalInfo({ isOpen: false, employee: null, shift: null, existingRecord: {} }); };
      const handleSaveFromModal = async (data) => { await onManualCheckIn(data, true); handleCloseModal(); };
      const getButtonState = (empId) => {
          const record = todayRecordsMap.get(String(empId));
          const hasCheckIn = record && checkEntryType(record.checkIn) !== 'EMPTY';
          const hasCheckOut = record && checkEntryType(record.checkOut) !== 'EMPTY';
          if (hasCheckIn && hasCheckOut) return { label: 'កែប្រែ', class: 'bg-green-600 hover:bg-green-700' };
          if (hasCheckIn) return { label: 'Check Out', class: 'bg-yellow-600 hover:bg-yellow-700' };
          return { label: 'Check In', class: 'bg-blue-500 hover:bg-blue-600' };
      };

      return (
        <div className="p-4 space-y-6">
          <h2 className={`text-center text-lg font-semibold ${textHeader}`}>ត្រួតពិនិត្យវត្តមាន ({formattedTitle})</h2>
          <div className="px-0"><label className={`block text-sm font-medium mb-1 ${textLabel}`}>ជ្រើសរើសកាលបរិច្ឆេទ</label><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className={`w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-blue-400 ${inputBg}`} /></div>
          <div className="px-0"><label className={`block text-sm font-medium mb-1 ${textLabel}`}>ស្វែងរក (ឈ្មោះ ឬ ID)</label><input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="វាយឈ្មោះ ឬ ID បុគ្គលិក..." className={`w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-blue-400 ${inputBg}`} /></div>
          <div className={`rounded-xl overflow-hidden ${bgCard}`}>
            <div className={`p-3 ${bgCard}`}><h3 className={`font-semibold ${textTitle}`}>បុគ្គលិកត្រូវវេន ({toKhmerNumber(scheduledStaff.length)})</h3></div>
            <div className="space-y-2 p-2 max-h-[30rem] overflow-y-auto custom-scrollbar">
              {loadingSchedules ? (<div className={`p-4 text-center ${textLabel}`}>កំពុងទាញកាលវិភាគ...</div>) : scheduledStaff.length === 0 ? (<div className={`p-4 text-center ${textLabel}`}>មិនមានបុគ្គលិកដែលត្រូវវេន (ផ្អែកលើតម្រង) សម្រាប់ថ្ងៃនេះទេ។</div>) : (
                scheduledStaff.map((emp) => {
                  const buttonState = getButtonState(emp['ID']);
                  let telegramUrl = emp['TELEGRAM'];
                  if (telegramUrl && !telegramUrl.startsWith('http') && !telegramUrl.startsWith('tg://')) telegramUrl = `https://t.me/${telegramUrl.replace('@', '')}`;
                  return (
                      <div key={emp['ID']} className={`flex items-center p-3 rounded-lg ${bgItem}`}>
                        <img src={emp['PHOTO'] || `https://placehold.co/40x40/E2E8F0/A0AEC0?text=${emp['NAME'] ? emp['NAME'][0] : 'P'}`} onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/40x40/E2E8F0/A0AEC0?text=${emp['NAME'] ? emp['NAME'][0] : 'P'}`; }} className="w-10 h-10 rounded-full object-cover mr-3" alt={emp['NAME']} />
                        <div className="flex-1 min-w-0">
                           <div className="flex items-center space-x-2">
                              <p className={`font-semibold truncate ${textName}`}>{emp['NAME']}</p>
                              {telegramUrl && (<a href={telegramUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:text-blue-600 flex-shrink-0"><TelegramIcon className="w-4 h-4" /></a>)}
                           </div>
                          <p className={`text-sm ${textDept}`}>{emp['GRADE'] && `${emp['GRADE']} | `}{emp['DEPT']} | <span className={`font-medium ${textId}`}>ID: {toKhmerNumber(emp['ID'])}</span></p>
                          <p className={`text-sm font-semibold ${textShift}`}>{getEmployeeShift(emp)}</p>
                        </div>
                        <div className="flex flex-col space-y-1 ml-2"><button onClick={() => handleOpenModal(emp)} className={`px-3 py-2 text-white text-xs font-medium rounded-md w-20 ${buttonState.class}`}>{buttonState.label}</button></div>
                      </div>
                  )
                })
              )}
            </div>
          </div>
          {modalInfo.isOpen && (<ManualEntryModal employee={modalInfo.employee} existingRecord={modalInfo.existingRecord} dateId={selectedDate} shift={modalInfo.shift} onSave={handleSaveFromModal} onClose={handleCloseModal} theme={theme} />)}
        </div>
      );
    };

    // --- 6. App Logic ---
    const firebaseConfig = { apiKey: "AIzaSyAc2g-t9A7du3K_nI2fJnw_OGxhmLfpP6s", authDomain: "dilistname.firebaseapp.com", databaseURL: "https://dilistname-default-rtdb.firebaseio.com", projectId: "dilistname", storageBucket: "dilistname.firebasestorage.app", messagingSenderId: "897983357871", appId: "1:897983357871:web:42a046bc9fb3e0543dc55a", measurementId: "G-NQ798D9J6K" };
    const studentListConfig = { apiKey: "AIzaSyAc2g-t9A7du3K_nI2fJnw_OGxhmLfpP6s", authDomain: "dilistname.firebaseapp.com", databaseURL: "https://dilistname-default-rtdb.firebaseio.com", projectId: "dilistname", storageBucket: "dilistname.firebasestorage.app", messagingSenderId: "897983357871", appId: "1:897983357871:web:42a046bc9fb3e0543dc55a", measurementId: "G-NQ798D9J6K" };
    const attendanceConfig = { apiKey: "AIzaSyCgc3fq9mDHMCjTRRHD3BPBL31JkKZgXFc", authDomain: "checkme-10e18.firebaseapp.com", databaseURL: "https://checkme-10e18-default-rtdb.firebaseio.com", projectId: "checkme-10e18", storageBucket: "checkme-10e18.firebasestorage.app", messagingSenderId: "1030447497157", appId: "1:1030447497157:web:9792086df1e864559fd5ac", measurementId: "G-QCJ2JH4WH6" };
    const VALID_SHIFTS = ["ពេញម៉ោង", "ពេលយប់", "ពេលព្រឹក", "មួយរសៀល", "Uptime"];

    if (!firebase.apps.length) { firebase.initializeApp(attendanceConfig); }
    let studentApp;
    try { studentApp = firebase.app("studentApp"); } catch (e) { studentApp = firebase.initializeApp(studentListConfig, "studentApp"); }
    const auth = firebase.auth();
    const attendanceDb = firebase.firestore(); 
    const studentDb = studentApp.database(); 

    function App() {
      const useStickyState = (defaultValue, key) => {
        const [value, setValue] = useState(() => { const stickyValue = window.localStorage.getItem(key); return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue; });
        useEffect(() => { window.localStorage.setItem(key, JSON.stringify(value)); }, [key, value]);
        return [value, setValue];
      };

      const [attendanceRecords, setAttendanceRecords] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [userId, setUserId] = useState(null);
      const [schedules, setSchedules] = useState({});
      const [loadingSchedules, setLoadingSchedules] = useState(true);

      const [activePage, setActivePage] = useStickyState('home', 'checkme_activePage');
      const [activeThemeKey, setActiveThemeKey] = useStickyState('glass', 'checkme_activeThemeKey');
      const [filterToday, setFilterToday] = useStickyState(false, 'checkme_filterToday');
      const [filterIncomplete, setFilterIncomplete] = useStickyState(false, 'checkme_filterIncomplete');
      const [filterIncompleteNotToday, setFilterIncompleteNotToday] = useStickyState(false, 'checkme_filterIncompleteNotToday');
      const [filterScannedInOnly, setFilterScannedInOnly] = useStickyState(false, 'checkme_filterScannedInOnly');
      const [filterCompleteScan, setFilterCompleteScan] = useStickyState(false, 'checkme_filterCompleteScan');
      const [filterUserShift, setFilterUserShift] = useStickyState('ALL', 'checkme_filterUserShift');
      const [entryMode, setEntryMode] = useStickyState(false, 'checkme_entryMode');
      const [adminGroupFilter, setAdminGroupFilter] = useStickyState('ALL', 'checkme_adminGroupFilter');
      const [adminShiftFilter, setAdminShiftFilter] = useStickyState('ALL', 'checkme_adminShiftFilter');
      const [editingRecord, setEditingRecord] = useState(null);
      const [currentPage, setCurrentPage] = useState(1);
      const [touchStartX, setTouchStartX] = useState(null);
      
      const themeArray = themes[activeThemeKey] || themes['glass'];
      const theme = { key: activeThemeKey, bgClass: themeArray[0], textClass: themeArray[1], name: themeArray[2] };

      useEffect(() => { const setAppHeight = () => { document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`); }; window.addEventListener('resize', setAppHeight); setAppHeight(); return () => window.removeEventListener('resize', setAppHeight); }, []);
      useEffect(() => { const unsubscribeAuth = auth.onAuthStateChanged((user) => { if (user) { setUserId(user.uid); } else { auth.signInAnonymously().catch((authError) => { console.error(authError); setError("មិនអាចភ្ជាប់ទៅសេវាកម្មផ្ទៀងផ្ទាត់បានទេ។"); setLoading(false); }); } }); return () => unsubscribeAuth(); }, []);
      useEffect(() => {
        if (!userId) return;
        const allRecordsQuery = attendanceDb.collectionGroup('records');
        setLoading(true); setError(null);
        const unsubscribeFirestore = allRecordsQuery.onSnapshot((querySnapshot) => {
          const records = [];
          querySnapshot.forEach((doc) => { const employeeId = doc.ref.parent.parent ? doc.ref.parent.parent.id : 'unknown'; records.push({ id: `${employeeId}-${doc.id}`, employeeId: employeeId, dateId: doc.id, ...doc.data() }); });
          records.sort((a, b) => b.dateId.localeCompare(a.dateId));
          setAttendanceRecords(records); setLoading(false);
        }, (firestoreError) => { console.error(firestoreError); setError("ទាញទិន្នន័យ Firestore មិនជោគជ័យ។"); setLoading(false); });
        return () => unsubscribeFirestore();
      }, [userId]);
      useEffect(() => {
        const fetchRTDBData = async () => {
          setLoadingSchedules(true);
          try {
            const snapshot = await studentDb.ref('students').once('value');
            if (snapshot.exists()) {
              const data = snapshot.val();
              const employeeData = {};
              Object.keys(data).forEach(key => {
                const item = data[key];
                employeeData[key] = { ID: key, GROUP: item['ក្រុម'] || '', NAME: item['ឈ្មោះ'] || '', GENDER: item['ភេទ'] || '', GRADE: item['ថ្នាក់'] || item['ជំនាន់'] || '', DEPT: item['ផ្នែកការងារ'] || '', SHIFT_MON: item['កាលវិភាគ']?.['ចន្ទ'] || '', SHIFT_TUE: item['កាលវិភាគ']?.['អង្គារ៍'] || '', SHIFT_WED: item['កាលវិភាគ']?.['ពុធ'] || '', SHIFT_THU: item['កាលវិភាគ']?.['ព្រហស្បត្តិ៍'] || '', SHIFT_FRI: item['កាលវិភាគ']?.['សុក្រ'] || '', SHIFT_SAT: item['កាលវិភាគ']?.['សៅរ៍'] || '', SHIFT_SUN: item['កាលវិភាគ']?.['អាទិត្យ'] || '', TELEGRAM: item['តេឡេក្រាម'] || '', PHOTO: item['រូបថត'] || '' };
              });
              setSchedules(employeeData);
            } else { setSchedules({}); }
          } catch (error) { console.error(error); setError("បរាជ័យក្នុងការទាញទិន្នន័យពី Realtime Database"); } finally { setLoadingSchedules(false); }
        };
        fetchRTDBData();
      }, []);

      const handleSaveRecord = async (updatedData, isAdminEntry = false) => {
        const { employeeId, dateId } = updatedData;
        if (!employeeId || !dateId) return;
        const recordDocRef = attendanceDb.collection('attendance').doc(String(employeeId)).collection('records').doc(dateId);
        let dataToSave = isAdminEntry ? updatedData : { checkIn: updatedData.checkIn, checkOut: updatedData.checkOut };
        if (isAdminEntry) delete dataToSave.id; 
        try { await recordDocRef.set(dataToSave, { merge: true }); setEditingRecord(null); } catch (e) { console.error(e); }
      };

      const handleTouchStart = (e) => { setTouchStartX(e.touches[0].clientX); };
      const handleTouchEnd = (e) => {
        if (!touchStartX) return;
        const touchEndX = e.changedTouches[0].clientX;
        const diffX = touchEndX - touchStartX;
        const threshold = 50;
        if (activePage === 'home') {
          // Note: totalPages logic needs filteredRecords length but simple toggle here for demo
          // Re-implementing logic here would be redundant, kept simple for page nav
        }
        setTouchStartX(null);
      };

      const getHeaderTitle = () => { switch (activePage) { case 'home': return 'បញ្ជីវត្តមាន'; case 'admin': return 'ពិនិត្យវត្តមាន'; case 'profile': return 'គណនីរបស់ខ្ញុំ'; case 'report': return 'របាយការណ៍'; case 'settings': return 'ការកំណត់'; default: return 'CheckMe App'; } };
      const handlePageChange = (page) => { setActivePage(page); };
      const { bgClass, textClass } = theme;
      const headerBg = bgClass.includes('gradient') ? 'bg-white/10 backdrop-blur-lg' : 'bg-white shadow-lg';
      const headerText = bgClass.includes('gradient') ? 'text-white' : 'text-gray-800';
      const footerBg = bgClass.includes('gradient') ? 'bg-white/10 backdrop-blur-lg' : 'bg-white shadow-[0_-4px_10px_-1px_rgba(0,0,0,0.05)]';
      const navText = bgClass.includes('gradient') ? 'text-gray-300' : 'text-gray-500';
      const navTextActive = bgClass.includes('gradient') ? 'text-white' : 'text-blue-600';
      const navBgActive = bgClass.includes('gradient') ? 'bg-white/20' : 'bg-blue-50';

      return (
        <div className={`w-full h-full min-h-screen ${bgClass}`} style={{ fontFamily: "'Kantumruy Pro', sans-serif" }}>
          <div className="w-full max-w-md mx-auto h-[var(--app-height)] shadow-2xl overflow-hidden flex flex-col">
            <header className={`flex-shrink-0 p-4 w-full z-10 transition-colors duration-300 ${headerBg}`}><h1 className={`text-xl font-bold text-center tracking-wide ${headerText}`}>{getHeaderTitle()}</h1></header>
            <main className={`flex-1 overflow-y-auto custom-scrollbar ${textClass}`} onTouchStart={handleTouchStart} onTouchEnd={handleTouchEnd}>
              <div key={activePage} className="page-content-animation">
                {activePage === 'home' && (<AttendanceList records={attendanceRecords} loading={loading} error={error} entryMode={entryMode} onRecordClick={(record) => setEditingRecord(record)} currentPage={currentPage} setCurrentPage={setCurrentPage} theme={theme} schedules={schedules || {}} filterUserShift={filterUserShift} />)}
                {activePage === 'admin' && (<AttendanceAdminPage schedules={schedules} attendanceRecords={attendanceRecords} onManualCheckIn={handleSaveRecord} theme={theme} loadingSchedules={loadingSchedules} adminGroupFilter="IT Support" adminShiftFilter={adminShiftFilter} VALID_SHIFTS={VALID_SHIFTS} />)}
                {activePage === 'profile' && <ProfilePage theme={theme} />}
                {activePage === 'report' && <ReportPage records={attendanceRecords} theme={theme} />}
                {activePage === 'settings' && (<SettingsPage filterToday={filterToday} setFilterToday={setFilterToday} filterIncomplete={filterIncomplete} setFilterIncomplete={setFilterIncomplete} filterIncompleteNotToday={filterIncompleteNotToday} setFilterIncompleteNotToday={setFilterIncompleteNotToday} filterScannedInOnly={filterScannedInOnly} setFilterScannedInOnly={setFilterScannedInOnly} filterCompleteScan={filterCompleteScan} setFilterCompleteScan={setFilterCompleteScan} filterUserShift={filterUserShift} setFilterUserShift={setFilterUserShift} entryMode={entryMode} setEntryMode={setEntryMode} activeThemeKey={activeThemeKey} onThemeChange={setActiveThemeKey} theme={theme} adminShiftFilter={adminShiftFilter} setAdminShiftFilter={setAdminShiftFilter} VALID_SHIFTS={VALID_SHIFTS} />)}
              </div>
            </main>
            <footer className={`flex-shrink-0 w-full flex justify-around items-center p-2 transition-colors duration-300 ${footerBg}`}>
              <button onClick={() => handlePageChange('home')} className={`flex flex-col items-center justify-center p-2 rounded-lg w-16 h-16 transition-all duration-200 ${activePage === 'home' ? `${navTextActive} ${navBgActive} scale-105` : `${navText} hover:bg-gray-500/10`}`} title="ទំព័រដើម"><HomeIcon className="w-7 h-7" /></button>
              <button onClick={() => handlePageChange('admin')} className={`flex flex-col items-center justify-center p-2 rounded-lg w-16 h-16 transition-all duration-200 ${activePage === 'admin' ? `${navTextActive} ${navBgActive} scale-105` : `${navText} hover:bg-gray-500/10`}`} title="ពិនិត្យវត្តមាន"><ClipboardListIcon className="w-7 h-7" /></button>
              <button onClick={() => handlePageChange('profile')} className={`flex flex-col items-center justify-center p-2 rounded-lg w-16 h-16 transition-all duration-200 ${activePage === 'profile' ? `${navTextActive} ${navBgActive} scale-105` : `${navText} hover:bg-gray-500/10`}`} title="គណនី"><UserIcon className="w-7 h-7" /></button>
              <button onClick={() => handlePageChange('report')} className={`flex flex-col items-center justify-center p-2 rounded-lg w-16 h-16 transition-all duration-200 ${activePage === 'report' ? `${navTextActive} ${navBgActive} scale-105` : `${navText} hover:bg-gray-500/10`}`} title="របាយការណ៍"><ChartBarIcon className="w-7 h-7" /></button>
              <button onClick={() => handlePageChange('settings')} className={`flex flex-col items-center justify-center p-2 rounded-lg w-16 h-16 transition-all duration-200 ${activePage === 'settings' ? `${navTextActive} ${navBgActive} scale-105` : `${navText} hover:bg-gray-500/10`}`} title="កំណត់"><SettingsIcon className="w-7 h-7" /></button>
            </footer>
            {editingRecord && (<EditModal record={editingRecord} onSave={handleSaveRecord} onClose={() => setEditingRecord(null)} theme={theme} />)}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
